<!DOCTYPE html>
<html>
<head>
  <title>Sneakon Social</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #eee;
    }

    input, button {
      margin: 6px 0;
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
    }

    input {
      background-color: #1e1e1e;
      color: #eee;
      border: 1px solid #333;
    }

    button {
      background-color: #333;
      color: #eee;
      cursor: pointer;
    }

    button:hover {
      background-color: #555;
    }

    #login-screen, #main {
      padding: 20px;
    }

    .hidden {
      display: none;
    }

    #sidebar {
      background: #1e1e1e;
      color: #eee;
      padding: 20px;
      width: 220px;
      min-height: 100vh;
      float: left;
    }

    #chat-area {
      margin-left: 240px;
      padding: 20px;
      padding-bottom: 80px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .message {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .message img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .text {
      background: #2a2a2a;
      color: #eee;
      padding: 10px;
      border-radius: 5px;
      max-width: 600px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    #chat-input {
      position: fixed;
      bottom: 20px;
      left: 240px;
      width: calc(100% - 260px);
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #333;
      background-color: #1e1e1e;
      color: #eee;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    }

    #send-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
    }

    h3, h4 {
      margin: 10px 0;
    }

    #avatar-preview {
      margin-top: 6px;
      border-radius: 6px;
    }

    #invite-code-output {
      font-style: italic;
      margin-top: 6px;
    }

    #dm-user-list h4 {
  padding: 6px 12px;
  margin: 4px 0;
  background-color: #1c1c1c;
  border-radius: 4px;
  cursor: pointer;
}

#dm-user-list h4:hover {
  background-color: #333;
}

#chat-area h4 {
  padding: 6px 12px;
  margin: 4px 0;
  background-color: #1c1c1c;
  border-radius: 4px;
  cursor: pointer;
}

#chat-area h4:hover {
  background-color: #333;
}

.kick-btn {
  font-size: 11px;
  padding: 2px 6px;
  background-color: #d33;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.danger-button {
  background-color: #e74c3c;
  color: white;
  border: none;
  padding: 10px 16px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.danger-button:hover {
  background-color: #c0392b;
}
  </style>
</head>
<body>
  <div id="login-screen">
    <h2>Login to Sneakon</h2>
    <input id="login-username" placeholder="Username"><br>
    <input id="login-password" type="password" placeholder="Password"><br>
    <input type="file" id="login-avatar"><br>
    <img id="avatar-preview" width="80"><br>
    <button onclick="login()">Login</button>
  </div>

  <div id="sidebar" class="hidden">
    <h3>Servers</h3>
    <ul id="server-list"></ul>

    <input id="new-server-name" placeholder="New server name">
    <button onclick="createServer()">Create Server</button><br>

    <input id="invite-code" placeholder="Enter invite code">
    <button onclick="joinServer()">Join Server</button><br><br>

    <h4>Invite Code Generator</h4>
    <input id="invite-server-name" placeholder="Server name">
    <button onclick="generateInviteCode()">Get Code</button>
    <div id="invite-code-output"></div><br>

    <button onclick="openDM()">Direct Messages</button>

    <a href="explore.html"><button>Explore Posts</button></a>
    
    
  <button id="leave-server-btn" class="danger-button">
    Leave Server
  </button>
</div>
  </div>

  <div id="main" class="hidden">
    <h3 id="current-location">Welcome</h3>  
    <input id="search-bar" type="text" placeholder="Search channels or users..." oninput="applySearch()" />
    <div id="chat-area"></div>
    <input id="chat-input" placeholder="Type a message...">
    <button id="send-btn" onclick="sendMessage()">Send</button>
  </div>
  <!-- Firebase App (core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>

<!-- Firebase Database -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
<script>
  let messageRefreshInterval = null;
  const BASE = 'https://fidgety-6bac3-default-rtdb.firebaseio.com';
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBCqTPyoKa7d0PSeNyafO77qmeDycKQ-_w",
  authDomain: "fidgety-6bac3.firebaseapp.com",
  databaseURL: "https://fidgety-6bac3-default-rtdb.firebaseio.com",
  projectId: "fidgety-6bac3",
  storageBucket: "fidgety-6bac3.firebasestorage.app",
  messagingSenderId: "490233635189",
  appId: "1:490233635189:web:4052ce11a728ea3274b33c",
  measurementId: "G-PT3TFJ3N2Y"
};

firebase.initializeApp(firebaseConfig);
  let currentUser = null;
  let currentChatPath = null;
  let currentServerName = null;
  let currentLocation = document.getElementById('current-location');

  const loginScreen = document.getElementById('login-screen');
  const mainScreen = document.getElementById('main');
  const sidebar = document.getElementById('sidebar');
  const avatarInput = document.getElementById('login-avatar');
  const avatarPreview = document.getElementById('avatar-preview');

  avatarInput.addEventListener('change', () => {
    const file = avatarInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => avatarPreview.src = reader.result;
      reader.readAsDataURL(file);
    }
  });

  async function login() {
    const uname = document.getElementById('login-username').value.trim();
    const pass = document.getElementById('login-password').value.trim();
    const avatarData = avatarPreview.src || `https://i.pravatar.cc/100?u=${uname}`;
    if (!uname || !pass) return alert("Username and password required");

    try {
      const res = await fetch(`${BASE}/users/${uname}.json`);
      const user = await res.json();

      if (user && user.password !== pass) return alert("Incorrect password");

      if (!user) {
        await fetch(`${BASE}/users/${uname}.json`, {
          method: 'PUT',
          body: JSON.stringify({ password: pass, avatar: avatarData })
        });
      }

      currentUser = { name: uname, avatar: avatarData };
      loginScreen.classList.add('hidden');
      sidebar.classList.remove('hidden');
      mainScreen.classList.remove('hidden');
      function checkInviteInURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const inviteCode = urlParams.get('invite');
  if (inviteCode) {
    console.log("Auto-joining via invite link:", inviteCode);
    joinServer(inviteCode);
  }
}
checkInviteInURL();

      loadServers();
    } catch (err) {
      console.error("Login failed:", err);
      alert("Check your Firebase URL or network connection.");
    }
  }

  function generateCode(length = 6) {
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < length; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

async function initVoiceChat(chatPath, userId) {
  if (!chatPath.includes("/voice")) return;

  const config = { iceServers: [{ urls: "stun:stun1.l.google.com:19302" }] };
  const peerConnections = {};
  let localStream;

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log("✅ Microphone access granted");
  } catch (err) {
    console.error("🚫 Microphone permission denied:", err);
    return;
  }

  const signalRef = firebase.database().ref(`${chatPath}/signals`);
  signalRef.push({ type: "join", userId });

  signalRef.on("child_added", async snapshot => {
    const signal = snapshot.val();
    if (!signal || signal.from === userId) return;

    console.log("🔔 Signal received:", signal);

    // Handle offer
    if (signal.type === "offer") {
      const pc = new RTCPeerConnection(config);
      peerConnections[signal.from] = pc;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = event => {
        console.log("📡 Remote stream received from", signal.from);
        attachRemoteAudio(event.streams[0]);
      };

      await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      signalRef.push({
        type: "answer", from: userId, to: signal.from, sdp: answer
      });

      console.log("📨 Answer sent to", signal.from);
    }

    // Handle answer
    if (signal.type === "answer" && signal.to === userId) {
      const pc = peerConnections[signal.from];
      if (!pc) {
        console.warn("⚠️ No peer connection found for", signal.from);
        return;
      }

      await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
      console.log("🧩 Remote description set from", signal.from);
    }
  });

  const pc = new RTCPeerConnection(config);
  peerConnections[userId] = pc;

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  pc.ontrack = event => {
    console.log("📡 Remote stream received from self-trigger");
    attachRemoteAudio(event.streams[0]);
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  signalRef.push({ type: "offer", from: userId, sdp: offer });
  console.log("🚀 Offer sent");

  // Show stream as visible audio element for debugging
  function attachRemoteAudio(stream) {
    const audioEl = document.createElement("audio");
    audioEl.srcObject = stream;
    audioEl.autoplay = true;
    audioEl.controls = true;
    audioEl.style.position = "fixed";
    audioEl.style.bottom = "10px";
    audioEl.style.left = "10px";
    audioEl.style.zIndex = "1000";
    document.body.appendChild(audioEl);
    console.log("🔊 Audio element attached");
  }

  // Mute toggle
  window.toggleMute = () => {
    localStream.getAudioTracks().forEach(track => {
      track.enabled = !track.enabled;
      console.log(track.enabled ? "🔈 Mic unmuted" : "🔇 Mic muted");
    });
  };
}

document.getElementById('leave-server-btn').onclick = async () => {
  if (!currentServerName) return alert("No server selected.");

  const serverRes = await fetch(`${BASE}/servers/${currentServerName}.json`);
  const server = await serverRes.json();

  if (!server) return alert("Server not found");

  const isOwner = server.owner === currentUser.name;

  if (isOwner) {
    await fetch(`${BASE}/servers/${currentServerName}.json`, {
      method: 'DELETE'
    });
    alert(`Server "${currentServerName}" deleted because you were the owner.`);
  } else {
    await fetch(`${BASE}/servers/${currentServerName}/invitedUsers/${currentUser.name}.json`, {
      method: 'DELETE'
    });
    alert(`You’ve left server: ${currentServerName}`);
  }

  currentServerName = null;
  loadServers();
  document.getElementById('chat-area').innerHTML = '';
  currentLocation.textContent = 'Direct Messages';
};

async function createServer() {
  const serverName = document.getElementById('new-server-name').value.trim();
  if (!serverName) return alert("Enter a server name");

  const inviteCode = generateCode();

  const serverData = {
    owner: currentUser.name,
    inviteCode,
    invitedUsers: { [currentUser.name]: true },
    channels: { general: true }
  };

  await fetch(`${BASE}/servers/${serverName}.json`, {
    method: 'PUT',
    body: JSON.stringify(serverData)
  });

  loadServers();
}

async function joinServer(codeFromUrl = null) {
  const code = codeFromUrl || document.getElementById('invite-code').value.trim();
  if (!code) return alert("Enter an invite code");

  try {
    const res = await fetch(`${BASE}/servers.json`);
    const servers = await res.json();

    let matchName = null;
    for (let name in servers) {
      const server = servers[name];
      if (server.inviteCode === code) {
        matchName = name;
        break;
      }
    }

    if (!matchName) return alert("Invalid invite code");

    const serverPath = `${BASE}/servers/${matchName}`;
    const serverRes = await fetch(`${serverPath}.json`);
    const server = await serverRes.json();

    server.invitedUsers = server.invitedUsers || {};
    server.invitedUsers[currentUser.name] = true;

    await fetch(`${serverPath}/invitedUsers.json`, {
      method: 'PUT',
      body: JSON.stringify(server.invitedUsers)
    });

    alert(`Joined server: ${matchName}`);
    loadServers();
  } catch (err) {
    console.error("Failed to join server:", err);
    alert("Network error. Please try again.");
  }
}

  function generateInviteCode() {
  const name = document.getElementById('invite-server-name').value.trim();
  if (!name) return alert("Server name required");

  fetch(`${BASE}/servers/${name}.json`)
    .then(res => res.json())
    .then(server => {
      if (!server) {
        return alert("Server not found.");
      }
      if (server.owner !== currentUser.name) {
        return alert("Only the server owner can view the invite code.");
      }

      const code = server.inviteCode || '(No code stored)';
      document.getElementById('invite-code-output').innerText = `Invite code: ${code}`;
    })
    .catch(err => {
      console.error("Error retrieving server:", err);
      alert("Something went wrong fetching the invite code.");
    });
}

async function openDM() {
  currentLocation.textContent = "Direct Messages";
  currentChatPath = null;
  const chatArea = document.getElementById('chat-area');
  chatArea.innerHTML = ''; // Clear chat area

  if (messageRefreshInterval) clearInterval(messageRefreshInterval);

  const res = await fetch(`${BASE}/users.json`);
  const users = await res.json() || {};

  for (let uname in users) {
    if (uname === currentUser.name) continue;

    const header = document.createElement('h4');
    header.textContent = `@ ${uname}`;
    header.setAttribute('data-label', uname.toLowerCase());
    header.style.display = 'block'; // Show by default

    header.onclick = () => {
      const names = [currentUser.name, uname].sort();
      const threadID = `${names[0]}_${names[1]}`;
      currentChatPath = `dm/${threadID}`;
      currentLocation.textContent = `DM with ${uname}`;
      chatArea.innerHTML = '';
      loadMessages(currentChatPath,isOwner = false,serverName = null);
    };

    chatArea.appendChild(header);
  }
}

  async function loadServers() {
    const res = await fetch(`${BASE}/servers.json`);
    const servers = await res.json() || {};
    const list = document.getElementById('server-list');
    list.innerHTML = '';

    for (let name in servers) {
      const s = servers[name];
      const isMember = s.owner === currentUser.name || (s.invitedUsers && s.invitedUsers[currentUser.name]);
      if (isMember) {
        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = () => loadChannels(name, s.owner === currentUser.name);
        list.appendChild(li);
      }
    }
  }

async function loadChannels(serverName, isOwner) {
  const chatArea = document.getElementById('chat-area');
  currentServerName = serverName;
  currentLocation.textContent = `Server: ${serverName}`;
  chatArea.innerHTML = '';

  if (messageRefreshInterval) {
  clearInterval(messageRefreshInterval);
  messageRefreshInterval = null;
}

  if (messageRefreshInterval) clearInterval(messageRefreshInterval);

  try {
    const res = await fetch(`${BASE}/servers/${serverName}/channels.json`);
    const channels = await res.json() || {};

    Object.keys(channels).forEach(channelName => {
      const header = document.createElement('h4');
      header.textContent = `# ${channelName}`;
      header.setAttribute('data-label', channelName.toLowerCase());
      header.style.cursor = 'pointer';

      header.onclick = () => {
  openChannel(serverName, channelName, isOwner);
  currentLocation.textContent = `Channel: #${channelName}`;
};

      if (isOwner) {
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '🗑';
        deleteBtn.title = 'Delete channel';
        deleteBtn.style.marginLeft = '6px';
        deleteBtn.onclick = async () => {
          await fetch(`${BASE}/servers/${serverName}/channels/${channelName}.json`, {
            method: 'DELETE'
          });
          loadChannels(serverName, true); // Refresh
        };

        header.appendChild(deleteBtn);
      }

      chatArea.appendChild(header);
    });

    if (isOwner) {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'New channel name';
      input.id = 'new-channel-input';
      input.style.marginTop = '16px';
      input.style.display = 'block';

      const btn = document.createElement('button');
      btn.textContent = 'Create Channel';
      btn.onclick = async () => {
        const newChannel = input.value.trim();
        if (!newChannel) return;

        await fetch(`${BASE}/servers/${serverName}/channels/${newChannel}.json`, {
          method: 'PUT',
          body: JSON.stringify(true)
        });

        loadChannels(serverName, true); // Refresh
      };

      chatArea.appendChild(input);
      chatArea.appendChild(btn);

      // 🔄 Load user list automatically for owners
      //loadUserList(serverName);
    }

  } catch (err) {
    console.error('Error loading channels:', err);
    chatArea.innerHTML = '<p>Failed to load channels.</p>';
  }
}

//async function loadUserList(serverName) {
//  const userArea = document.getElementById('user-area');
//  userArea.innerHTML = '<h3>Server Members</h3>'; // Always keep header
//
//  try {
//    const res = await fetch(`${BASE}/servers/${serverName}/users.json`);
//    const users = await res.json() || {};
//
//    Object.entries(users).forEach(([userId, username]) => {
//      const entry = document.createElement('div');
//      entry.textContent = username;
//      entry.style.display = 'flex';
//      entry.style.justifyContent = 'space-between';
//      entry.style.alignItems = 'center';
//
//      const kickBtn = document.createElement('button');
//      kickBtn.textContent = 'Kick';
//      kickBtn.onclick = async () => {
//        await fetch(`${BASE}/servers/${serverName}/users/${userId}.json`, {
//          method: 'DELETE'
//        });
//        loadUserList(serverName); // Refresh list
//      };
//
//      entry.appendChild(kickBtn);
//      userArea.appendChild(entry);
//    });
//
//  } catch (err) {
//    console.error('Error loading users:', err);
//    userArea.innerHTML += '<p>Failed to load members.</p>';
//  }
//}

async function leaveServer(serverName, userId) {
  await fetch(`${BASE}/servers/${serverName}/users/${userId}.json`, {
    method: 'DELETE'
  });
  window.location.reload(); // Or redirect to home
}



async function openChannel(serverName, channelName, isOwner) {
  const fullPath = `servers/${serverName}/channels/${channelName}`;
  currentChatPath = fullPath;
  currentLocation.textContent = `Channel: #${channelName}`;

  initVoiceChat(currentChatPath, currentUser);

  if (messageRefreshInterval) clearInterval(messageRefreshInterval);

  loadMessages(fullPath, isOwner, serverName);
}

  function applySearch() {
  const query = document.getElementById('search-bar').value.toLowerCase();
  const headers = document.querySelectorAll('#chat-area h4');

  headers.forEach(h => {
    const label = h.getAttribute('data-label');
    h.style.display = label && label.includes(query) ? 'block' : 'none';
  });
}
async function loadMessages(path, isOwner, serverName) {
  currentChatPath = path;
  const messageContainer = document.getElementById('chat-area');
  if (!messageContainer) return console.error("Missing #chat-area container");

  const chatArea = document.getElementById('chat-area');
if (chatArea) {
  const h4s = chatArea.querySelectorAll('h4');
  h4s.forEach(h4 => h4.remove());
}

  try {
    const [userRes, msgRes] = await Promise.all([
      fetch(`${BASE}/users.json`),
      fetch(`${BASE}/${path}/messages.json`)
    ]);

    const users = await userRes.json() || {};
    const messages = await msgRes.json() || {};

    const existingMessages = new Set(
      Array.from(messageContainer.children).map(el => el.getAttribute('data-id'))
    );

    Object.entries(messages).forEach(([id, msg]) => {
      if (existingMessages.has(id)) return; // Already rendered

      const wrapper = document.createElement('div');
      wrapper.className = 'message';
      wrapper.setAttribute('data-id', id);
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.style.marginBottom = '10px';

      const avatar = document.createElement('img');
      avatar.src = users[msg.sender]?.avatar || `https://i.pravatar.cc/40?u=${msg.sender}`;
      avatar.alt = `${msg.sender}'s avatar`;
      avatar.style.width = '36px';
      avatar.style.height = '36px';
      avatar.style.borderRadius = '50%';
      avatar.style.marginRight = '10px';

      const textBlock = document.createElement('div');
      textBlock.style.display = 'flex';
      textBlock.style.flexDirection = 'column';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.style.gap = '8px';

      const username = document.createElement('strong');
      username.textContent = msg.sender;
      header.appendChild(username);

      if (isOwner && users[msg.sender]) {
        const kickBtn = document.createElement('button');
        kickBtn.textContent = 'Kick';
        kickBtn.className = 'kick-btn';
        kickBtn.onclick = async () => {
          await fetch(`${BASE}/servers/${serverName}/users/${msg.sender}.json`, {
            method: 'DELETE'
          });
          //loadUserList(serverName);
        };
        header.appendChild(kickBtn);
      }

      const text = document.createElement('span');
      text.textContent = msg.text;

      textBlock.appendChild(header);
      textBlock.appendChild(text);

      wrapper.appendChild(avatar);
      wrapper.appendChild(textBlock);
      messageContainer.appendChild(wrapper);
    });

  } catch (err) {
    console.error("Failed to load messages:", err);
    if (!messageContainer.querySelector('.message')) {
      messageContainer.innerHTML = '<p>Unable to load messages.</p>';
    }
  }
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg || !currentChatPath) return;

const fetchAndRender = async () => {
  if (!currentChatPath) return;
  await loadMessages(currentChatPath, null, null);
};

  const message = {
    sender: currentUser.name,
    text: msg,
    timestamp: Date.now()
  };

  await fetch(`${BASE}/${currentChatPath}/messages.json`, {
    method: 'POST',
    body: JSON.stringify(message)
  });

  input.value = '';

  await fetchAndRender();
  messageRefreshInterval = setInterval(fetchAndRender, 4000); // refresh every 4s
}
</script>
</body>
</html>