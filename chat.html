<!-- Sneakon Social Full App (Login + Chat + Server System + DMs) -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sneakon Social</title>
  <style>
    html, body {
      margin: 0;
      font-family: sans-serif;
      background: #2f3136;
      color: #eee;
      height: 100vh;
    }
    #login-screen, #main-screen {
      display: none;
      padding: 2rem;
    }
    .visible { display: block; }
    input, button {
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    #avatar-preview { width: 60px; height: 60px; border-radius: 50%; }
    nav ul { list-style: none; padding: 0; }
    nav li { padding: 0.5rem; cursor: pointer; }
    nav li.active, nav li:hover { background: #40444b; }
    #chat-box { height: 300px; overflow-y: auto; margin: 1rem 0; }
    .message { margin-bottom: 0.5rem; }
    .message img { width: 24px; height: 24px; border-radius: 50%; margin-right: 0.5rem; }
    .inline { display: flex; align-items: center; }
  </style>
</head>
<body>
  <div id="login-screen" class="visible">
    <h1>Login to Sneakon</h1>
    <input type="text" id="login-username" placeholder="Username" />
    <input type="password" id="login-password" placeholder="Password" />
    <input type="file" id="login-avatar" accept="image/*" />
    <img id="avatar-preview" src="" alt="" />
    <button onclick="login()">Login / Register</button>
  </div>

  <div id="main-screen">
    <h2>Welcome, <span id="user-display"></span></h2>
    <button onclick="logout()">Logout</button>
    <nav>
      <h3>Your Servers</h3>
      <ul id="server-list"></ul>
      <input type="text" id="new-server-name" placeholder="New Server Name" />
      <button onclick="createServer()">Create Server</button>

      <h3>Channels in Selected Server</h3>
      <ul id="channel-list"></ul>
      <input type="text" id="new-channel-name" placeholder="New Channel Name" />
      <button onclick="createChannel()">Add Channel</button>

      <h3>DMs</h3>
      <ul id="dm-list"></ul>
      <input type="text" id="dm-user" placeholder="User to DM" />
      <button onclick="startDM()">Start DM</button>
    </nav>

    <div id="chat-box"></div>
    <input type="text" id="chat-input" placeholder="Type message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    const BASE = 'https://fidgety-6bac3-default-rtdb.firebaseio.com';
    let currentUser = null;
    let currentChatPath = null;

    async function login() {
      const uname = document.getElementById('login-username').value.trim();
      const pass = document.getElementById('login-password').value.trim();
      const file = document.getElementById('login-avatar').files[0];

      if (!uname || !pass) return alert('Enter username and password');

      let avatarURL = `https://i.pravatar.cc/100?u=${uname}`;
      if (file) {
        const reader = new FileReader();
        reader.onload = async () => {
          avatarURL = reader.result;
          document.getElementById('avatar-preview').src = avatarURL;
          await authUser(uname, pass, avatarURL);
        };
        reader.readAsDataURL(file);
      } else {
        await authUser(uname, pass, avatarURL);
      }
    }

    async function authUser(uname, pass, avatar) {
      const res = await fetch(`${BASE}/users/${uname}.json`);
      const userData = await res.json();
      if (userData && userData.password !== pass) {
        return alert('Incorrect password');
      }
      if (!userData) {
        await fetch(`${BASE}/users/${uname}.json`, {
          method: 'PUT',
          body: JSON.stringify({ password: pass, avatar })
        });
      }
      currentUser = { name: uname, avatar };
      document.getElementById('login-screen').classList.remove('visible');
      document.getElementById('main-screen').classList.add('visible');
      document.getElementById('user-display').textContent = uname;
      loadServers();
      loadDMs();
    }

    function logout() {
      currentUser = null;
      location.reload();
    }

    async function createServer() {
      const name = document.getElementById('new-server-name').value.trim();
      if (!name) return;
      await fetch(`${BASE}/servers/${name}.json`, {
        method: 'PUT',
        body: JSON.stringify({ owner: currentUser.name, channels: {} })
      });
      loadServers();
    }

    async function createChannel() {
      const server = document.querySelector('#server-list li.active')?.textContent;
      const channel = document.getElementById('new-channel-name').value.trim();
      if (!server || !channel) return;
      await fetch(`${BASE}/servers/${server}/channels/${channel}.json`, {
        method: 'PUT',
        body: JSON.stringify(true)
      });
      loadChannels(server);
    }

    async function startDM() {
      const other = document.getElementById('dm-user').value.trim();
      if (!other) return;
      const path = `dms/${[currentUser.name, other].sort().join('_')}`;
      addDMItem(other, path);
      currentChatPath = path;
      loadMessages(path);
    }

    async function loadServers() {
      const res = await fetch(`${BASE}/servers.json`);
      const data = await res.json();
      const list = document.getElementById('server-list');
      list.innerHTML = '';
      for (let s in data) {
        if (data[s].owner === currentUser.name) {
          const li = document.createElement('li');
          li.textContent = s;
          li.onclick = () => {
            document.querySelectorAll('#server-list li').forEach(el => el.classList.remove('active'));
            li.classList.add('active');
            loadChannels(s);
          };
          list.appendChild(li);
        }
      }
    }

    async function loadChannels(server) {
      const res = await fetch(`${BASE}/servers/${server}/channels.json`);
      const data = await res.json();
      const list = document.getElementById('channel-list');
      list.innerHTML = '';
      for (let c in data) {
        const li = document.createElement('li');
        li.textContent = c;
        li.onclick = () => {
          document.querySelectorAll('#channel-list li').forEach(el => el.classList.remove('active'));
          li.classList.add('active');
          currentChatPath = `channels/${server}/${c}`;
          loadMessages(currentChatPath);
        };
        list.appendChild(li);
      }
    }

    async function loadDMs() {
      const res = await fetch(`${BASE}/users.json`);
      const data = await res.json();
      const list = document.getElementById('dm-list');
      list.innerHTML = '';
      for (let u in data) {
        if (u !== currentUser.name) {
          const path = `dms/${[currentUser.name, u].sort().join('_')}`;
          addDMItem(u, path);
        }
      }
    }

    function addDMItem(name, path) {
      const li = document.createElement('li');
      li.textContent = name;
      li.onclick = () => {
        document.querySelectorAll('#dm-list li').forEach(el => el.classList.remove('active'));
        li.classList.add('active');
        currentChatPath = path;
        loadMessages(path);
      };
      document.getElementById('dm-list').appendChild(li);
    }

    async function loadMessages(path) {
      const res = await fetch(`${BASE}/messages/${path}.json`);
      const data = await res.json() || {};
      const box = document.getElementById('chat-box');
      box.innerHTML = '';
      for (let key in data) {
        const m = data[key];
        const div = document.createElement('div');
        div.className = 'message inline';
        div.innerHTML = `
          <img src="${m.avatar}" />
          <strong>${m.author}</strong>: ${m.content}
        `;
        box.appendChild(div);
      }
      box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
      const text = document.getElementById('chat-input').value.trim();
      if (!text || !currentChatPath) return;
      await fetch(`${BASE}/messages/${currentChatPath}.json`, {
        method: 'POST',
        body: JSON.stringify({
          author: currentUser.name,
          avatar: currentUser.avatar,
          content: text,
          timestamp: Date.now()
        })
      });
      document.getElementById('chat-input').value = '';
      loadMessages(currentChatPath);
    }
  </script>
</body>
</html>