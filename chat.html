<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sneakon Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0; font-family: 'Segoe UI'; background: #0d0d0f; color: #f1f1f1;
    }
    header { display: flex; align-items: center; gap: 10px; background: #1c1c1f; padding: 10px; border-bottom: 1px solid #333; }
    #avatarPreview { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #444; }
    #displayName { font-weight: bold; font-size: 1.1em; }
    #chatTitle { margin-left: auto; font-size: 1.1em; }
    #loginContainer, #sidebar, #chatArea { padding: 20px; }
    input, button {
      padding: 8px; margin-bottom: 10px; border: 1px solid #444;
      border-radius: 6px; background: #252528; color: #f1f1f1;
    }
    button { background: #393943; cursor: pointer; }
    button:hover { background: #57575f; }
    #sidebar { position: absolute; top: 54px; left: 0; width: 240px; height: calc(100vh - 54px); background: #141417; border-right: 1px solid #333; overflow-y: auto; }
    #chatArea { margin-left: 240px; margin-top: 54px; height: calc(100vh - 54px); display: flex; flex-direction: column; background: #1a1a1d; }
    #chatBox { flex-grow: 1; background: #111; padding: 10px; border-radius: 6px; border: 1px solid #333; margin-bottom: 10px; overflow-y: auto; }
    .message { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; background: #2a2a2f; padding: 6px; border-radius: 6px; }
    li { background: #1f1f22; padding: 6px; border-radius: 4px; margin-bottom: 6px; cursor: pointer; }
    li:hover { background: #2c2c30; }
  </style>

  <script type="module">
    const BASE_URL = "https://fidgety-6bac3-default-rtdb.firebaseio.com";

    window.addEventListener("DOMContentLoaded", () => {
      const loginContainer = document.getElementById("loginContainer");
      const sidebar = document.getElementById("sidebar");
      const chatArea = document.getElementById("chatArea");

      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");

      loginBtn.addEventListener("click", async () => {
  const uname = usernameInput.value.trim();
  const pass = passwordInput.value.trim();

  if (!uname || !pass) return alert("Please enter both username and password");

  try {
    const res = await fetch(`${BASE_URL}/users/${uname}.json`);
    const userData = await res.json();

    // ðŸŸ¢ User exists: check password
    if (userData) {
      if (userData.password !== pass) return alert("Incorrect password");

      activateUser(userData.name || uname, userData.avatar || "", uname);
    } else {
      // ðŸ†• Create new user
      const newUser = {
        name: uname,
        password: pass,
        avatar: `https://i.pravatar.cc/100?u=${uname}`, // ðŸŽ­ Default avatar
        uid: uname
      };

      const createRes = await fetch(`${BASE_URL}/users/${uname}.json`, {
        method: "PUT",
        body: JSON.stringify(newUser)
      });

      if (createRes.ok) {
        activateUser(newUser.name, newUser.avatar, uname);
      } else {
        alert("Failed to create user");
      }
    }
  } catch (err) {
    console.error("Login error:", err);
    alert("Login failed");
  }
});

// ðŸŽ® User UI activation
function activateUser(name, avatar, uid) {
  loginContainer.style.display = "none";
  sidebar.style.display = "block";
  chatArea.style.display = "flex";
  document.getElementById("displayName").textContent = name;
  document.getElementById("avatarPreview").src = avatar;
  loadServers(uid);
}

      async function loadServers() {
        try {
          const res = await fetch(`${BASE_URL}/servers.json`);
          const serversData = await res.json();
          const serverList = document.getElementById("serverList");
          const channelList = document.getElementById("channelList");

          serverList.innerHTML = '';
          channelList.innerHTML = '';

          Object.entries(serversData || {}).forEach(([id, server]) => {
            const displayName = server?.members?.name || server?.name || id;
            const li = document.createElement("li");
            li.textContent = displayName;

            li.addEventListener("click", async () => {
              channelList.innerHTML = '';
              try {
                const channelRes = await fetch(`${BASE_URL}/servers/${id}/channels.json`);
                const channels = await channelRes.json();

                Object.entries(channels || {}).forEach(([cid, channel]) => {
                  const channelLi = document.createElement("li");
                  channelLi.textContent = channel?.name || cid;
                  channelList.appendChild(channelLi);
                });
              } catch (err) {
                console.error("Channel fetch error:", err);
              }
            });

            serverList.appendChild(li);
          });
        } catch (err) {
          console.error("Server fetch error:", err);
        }
      }

      const sendBtn = document.getElementById("sendBtn");
      const msgInput = document.getElementById("msgInput");
      const chatBox = document.getElementById("chatBox");

      sendBtn.addEventListener("click", () => {
        const text = msgInput.value.trim();
        if (!text) return;

        const msgEl = document.createElement("div");
        msgEl.className = "message";
        msgEl.innerHTML = `
          <img src="${avatarPreview.src}" width="24" height="24" style="border-radius:50%;" />
          <strong>${displayName.textContent}</strong> <span>${text}</span>
        `;
        chatBox.appendChild(msgEl);
        msgInput.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });
  </script>
</head>

<body>
  <header>
    <img id="avatarPreview" src="" alt="Avatar" />
    <span id="displayName"></span>
    <span id="chatTitle">Sneakon</span>
  </header>

  <div id="loginContainer">
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
  </div>

  <div id="sidebar" style="display:none;">
    <h3>Servers</h3>
    <ul id="serverList"></ul>
    <h3>Channels</h3>
    <ul id="channelList"></ul>
  </div>

  <div id="chatArea" style="display:none;">
    <div id="chatBox"></div>
    <div style="display:flex;">
      <input type="text" id="msgInput" placeholder="Speak your mind..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</body>
</html>